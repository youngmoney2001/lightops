<div class="p-6">
  <!-- En-tête avec contrôles -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">Tableau de Bord de Monitoring</h1>
      <p class="text-gray-600">Surveillance en temps réel du système de tracking animal LoRaWAN</p>
    </div>

    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">Période:</span>
        <select [(ngModel)]="selectedTimeRange"
                (change)="refreshMetrics()"
                class="border border-gray-300 rounded px-3 py-1 text-sm"
                title="Select a time range">
          <option *ngFor="let range of timeRanges" [value]="range.value">{{range.label}}</option>
        </select>
      </div>

      <div class="flex items-center gap-2">
        <input type="checkbox" id="autoRefresh" [(ngModel)]="autoRefresh" class="w-4 h-4">
        <label for="autoRefresh" class="text-sm text-gray-600">Auto-rafraîchissement</label>
      </div>

      <button (click)="refreshMetrics()"
              class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition flex items-center gap-2">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
        </svg>
        Actualiser
      </button>
    </div>
  </div>

  <!-- KPI Principaux -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Capteurs Actifs -->
    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 mb-1">Capteurs Actifs</p>
          <p class="text-2xl font-bold text-gray-800">
            {{ (networkMetrics$ | async)?.activeSensors || 0 }}/{{ (networkMetrics$ | async)?.totalSensors || 0 }}
          </p>
        </div>
        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
          </svg>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex justify-between text-sm mb-1">
          <span class="text-gray-600">Disponibilité</span>
          <span class="font-semibold">{{ ((networkMetrics$ | async)?.systemAvailability || 0).toFixed(1) }}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-blue-500 h-2 rounded-full"
               [style.width.%]="(networkMetrics$ | async)?.systemAvailability || 0"></div>
        </div>
      </div>
    </div>

    <!-- Passerelles en Ligne -->
    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 mb-1">Passerelles en Ligne</p>
          <p class="text-2xl font-bold text-gray-800">
            {{ (networkMetrics$ | async)?.onlineGateways || 0 }}/{{ (networkMetrics$ | async)?.totalGateways || 0 }}
          </p>
        </div>
        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-green-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
          </svg>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex justify-between text-sm mb-1">
          <span class="text-gray-600">Qualité GPS Moyenne</span>
          <span class="font-semibold">{{ ((networkMetrics$ | async)?.avgGpsQuality || 0).toFixed(1) }}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-green-500 h-2 rounded-full"
               [style.width.%]="(networkMetrics$ | async)?.avgGpsQuality || 0"></div>
        </div>
      </div>
    </div>

    <!-- Performance LoRaWAN -->
    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 mb-1">Performance LoRaWAN</p>
          <p class="text-2xl font-bold text-gray-800">
            {{ ((loraMetrics$ | async)?.positionSuccessRate || 0).toFixed(1) }}%
          </p>
        </div>
        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/>
          </svg>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex justify-between text-sm mb-1">
          <span class="text-gray-600">Latence Moyenne</span>
          <span class="font-semibold">{{ ((networkMetrics$ | async)?.avgLatency || 0).toFixed(2) }}s</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-purple-500 h-2 rounded-full"
               [style.width.%]="Math.min(100, ((networkMetrics$ | async)?.avgLatency || 0) * 20)"></div>
        </div>
      </div>
    </div>

    <!-- Alertes Actives -->
    <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600 mb-1">Alertes Actives</p>
          <p class="text-2xl font-bold text-gray-800">
            {{ activeAlertsCount }}
            <span class="text-sm font-normal text-red-500 ml-1">
              ({{ criticalAlertsCount }} critiques)
            </span>
          </p>
        </div>
        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex justify-between text-sm mb-1">
          <span class="text-gray-600">Non acquittées</span>
          <span class="font-semibold">{{ unacknowledgedAlertsCount }}</span>
        </div>
        <button (click)="acknowledgeAllAlerts()"
                *ngIf="unacknowledgedAlertsCount > 0"
                class="w-full mt-2 px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition">
          Tout acquitter
        </button>
      </div>
    </div>
  </div>

  <!-- Métriques Détaillées -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Statistiques Réseau -->
    <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-bold text-gray-800">Statistiques Réseau</h3>
        <span class="text-sm text-gray-500">Dernière mise à jour: {{ now | date:'HH:mm:ss' }}</span>
      </div>

      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div class="p-3 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-600 mb-1">Connexions Actives</p>
            <p class="text-xl font-bold text-gray-800">
              {{ ((networkMetrics$ | async)?.connectivity?.active_connections || 0).toLocaleString() }}
            </p>
          </div>
          <div class="p-3 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-600 mb-1">Taux de Perte</p>
            <p class="text-xl font-bold text-gray-800">
              {{ ((networkMetrics$ | async)?.packetLossRate || 0).toFixed(2) }}%
            </p>
          </div>
        </div>

        <div>
          <p class="text-sm text-gray-600 mb-2">Transfert de Données</p>
          <div class="flex justify-between items-center">
            <div>
              <p class="text-lg font-bold text-gray-800">
                {{ formatBytes((networkMetrics$ | async)?.data_transfer?.total_bytes_total || 0) }}
              </p>
              <p class="text-sm text-gray-500">Total</p>
            </div>
            <div>
              <p class="text-lg font-bold text-gray-800">
                {{ formatBytes((networkMetrics$ | async)?.data_transfer?.avg_bytes_per_hour || 0) }}/h
              </p>
              <p class="text-sm text-gray-500">Moyenne par heure</p>
            </div>
          </div>
        </div>

        <div>
          <p class="text-sm text-gray-600 mb-2">Latence Réseau</p>
          <div class="flex items-center gap-4">
            <div class="flex-1">
              <div class="flex justify-between text-sm mb-1">
                <span>Moyenne</span>
                <span class="font-semibold">{{ ((networkMetrics$ | async)?.latency?.avg_latency_ms || 0).toFixed(1) }}ms</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-500 h-2 rounded-full"
                     [style.width.%]="Math.min(100, ((networkMetrics$ | async)?.latency?.avg_latency_ms || 0) / 5)"></div>
              </div>
            </div>
            <div class="flex-1">
              <div class="flex justify-between text-sm mb-1">
                <span>Maximale</span>
                <span class="font-semibold">{{ ((networkMetrics$ | async)?.latency?.max_latency_ms || 0).toFixed(1) }}ms</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-red-500 h-2 rounded-full"
                     [style.width.%]="Math.min(100, ((networkMetrics$ | async)?.latency?.max_latency_ms || 0) / 10)"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Métriques LoRaWAN -->
    <div class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-6">Métriques LoRaWAN</h3>

      <div class="space-y-6">
        <!-- Distribution des Modes -->
        <div>
          <p class="text-sm text-gray-600 mb-3">Distribution des Modes Opérationnels</p>
          <div class="space-y-2">
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span>Mode Périodique</span>
                <span class="font-semibold">{{ ((loraMetrics$ | async)?.operationMode?.periodic || 0).toFixed(1) }}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-500 h-2 rounded-full"
                     [style.width.%]="(loraMetrics$ | async)?.operationMode?.periodic || 0"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span>Mode Normal</span>
                <span class="font-semibold">{{ ((loraMetrics$ | async)?.operationMode?.normal || 0).toFixed(1) }}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-green-500 h-2 rounded-full"
                     [style.width.%]="(loraMetrics$ | async)?.operationMode?.normal || 0"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span>Mode Alerte</span>
                <span class="font-semibold">{{ ((loraMetrics$ | async)?.operationMode?.alert || 0).toFixed(1) }}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-red-500 h-2 rounded-full"
                     [style.width.%]="(loraMetrics$ | async)?.operationMode?.alert || 0"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- État des Batteries -->
        <div>
          <p class="text-sm text-gray-600 mb-3">État des Batteries</p>
          <div class="grid grid-cols-3 gap-3">
            <div class="text-center">
              <div class="text-2xl font-bold text-green-600">
                {{ ((loraMetrics$ | async)?.batteryStatus?.normal || 0).toFixed(0) }}%
              </div>
              <p class="text-xs text-gray-600">Normales</p>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-yellow-600">
                {{ ((loraMetrics$ | async)?.batteryStatus?.low || 0).toFixed(0) }}%
              </div>
              <p class="text-xs text-gray-600">Faibles</p>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-red-600">
                {{ ((loraMetrics$ | async)?.batteryStatus?.critical || 0).toFixed(0) }}%
              </div>
              <p class="text-xs text-gray-600">Critiques</p>
            </div>
          </div>
        </div>

        <!-- Liaisons Réseau -->
        <div>
          <p class="text-sm text-gray-600 mb-3">Qualité des Liaisons</p>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="text-center p-3 bg-green-50 rounded-lg">
              <div class="text-xl font-bold text-green-700">
                {{ ((loraMetrics$ | async)?.excellentLinks || 0).toLocaleString() }}
              </div>
              <p class="text-xs text-green-600">Excellent</p>
            </div>
            <div class="text-center p-3 bg-blue-50 rounded-lg">
              <div class="text-xl font-bold text-blue-700">
                {{ ((loraMetrics$ | async)?.goodLinks || 0).toLocaleString() }}
              </div>
              <p class="text-xs text-blue-600">Bonnes</p>
            </div>
            <div class="text-center p-3 bg-yellow-50 rounded-lg">
              <div class="text-xl font-bold text-yellow-700">
                {{ ((loraMetrics$ | async)?.poorLinks || 0).toLocaleString() }}
              </div>
              <p class="text-xs text-yellow-600">Faibles</p>
            </div>
            <div class="text-center p-3 bg-red-50 rounded-lg">
              <div class="text-xl font-bold text-red-700">
                {{ ((loraMetrics$ | async)?.criticalLinks || 0).toLocaleString() }}
              </div>
              <p class="text-xs text-red-600">Critiques</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alertes Récentes -->
  <div class="bg-white rounded-xl shadow-lg p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-lg font-bold text-gray-800">Alertes Récentes</h3>
      <span class="text-sm text-gray-500">{{ activeAlertsCount }} alertes actives</span>
    </div>

    <div class="space-y-3">
      <div *ngFor="let alert of alerts$ | async | slice:0:5"
           [class]="'border-l-4 p-4 rounded ' + getAlertColor(alert.type)">
        <div class="flex justify-between items-start">
          <div class="flex items-start gap-3">
            <div class="text-2xl">{{ getAlertIcon(alert.type) }}</div>
            <div>
              <h4 class="font-semibold mb-1">{{ alert.title }}</h4>
              <p class="text-sm text-gray-700 mb-2">{{ alert.message }}</p>
              <div class="flex items-center gap-4 text-xs text-gray-500">
                <span>{{ alert.source.type }}: {{ alert.source.name }}</span>
                <span>{{ alert.timestamp | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <span *ngIf="!alert.acknowledged" class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">
              Non acquittée
            </span>
            <button *ngIf="!alert.acknowledged"
                    (click)="acknowledgeAlert(alert)"
                    class="px-3 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 transition">
              Acquitter
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="(alerts$ | async)?.length === 0" class="text-center py-8 text-gray-500">
        <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p>Aucune alerte active</p>
      </div>
    </div>
  </div>
</div>
